// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client"
    output   = "../src/generated/prisma"
}

datasource db {
    provider = "postgresql"
    // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
    // Further reading:
    // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
    // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
}

// Necessary for Next auth
model Account {
    id                       String  @id @default(cuid())
    userId                   String
    type                     String
    provider                 String
    providerAccountId        String
    refresh_token            String?
    access_token             String?
    expires_at               Int?
    token_type               String?
    scope                    String?
    id_token                 String?
    session_state            String?
    user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    refresh_token_expires_in Int?

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
    id               String            @id @default(cuid())
    name             String?
    email            String?           @unique
    emailVerified    DateTime?
    image            String?
    accounts         Account[]
    sessions         Session[]
    CloudCredentials CloudCredential[]
    EdgeDevices      EdgeDevice[]
    Clusters         Cluster[]
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

enum Provider {
    GCP
    AWS
    EDGE
}

// Lifecycle status of a Cluster or Node
enum Status {
    PENDING // Resource is queued for creation/deletion
    PROVISIONING // Resource is currently being created/configured
    ACTIVE // Resource is running and ready for use
    FAILED // An error occurred during the last operation
    DELETING // Resource is being destroyed
    STOPPED // Resource is shut down (for Cloud VMs)
}

// Supported cluster orchestration software
enum ClusterSoftware {
    K3S
    NOMAD
    DOCKER_SWARM
    KUBERNETES
}

// Stores authentication tokens for cloud providers (Objective 000)
model CloudCredential {
    id        String   @id @default(cuid())
    userId    String
    provider  Provider // Uses the Provider Enum (GCP, AWS)
    name      String
    // The sensitive key/account data should be encrypted in a real app
    accessKey String
    secretKey String? // For AWS
    projectId String? // For GCP
    region    String // Default region for creation

    user  User   @relation(fields: [userId], references: [id])
    nodes Node[]
}

// Stores connection info for local/on-premise machines (Objective 001)
model EdgeDevice {
    id           String  @id @default(cuid())
    userId       String
    name         String
    ipAddress    String  @unique
    sshUser      String
    // SSH Private Key should be securely stored (or agent-forwarded)
    // For this hackathon, storing the public key or a simple password might suffice
    sshPublicKey String?

    user User  @relation(fields: [userId], references: [id])
    Node Node?
}

// Represents a collection of machines working together (the multi-cloud cluster)
model Cluster {
    id              String          @id @default(cuid())
    userId          String
    name            String
    createdAt       DateTime        @default(now())
    status          Status // Uses the Status Enum
    clusterSoftware ClusterSoftware // Uses the ClusterSoftware Enum

    // In a real app, this field should be encrypted :)
    sshPrivateKey String?

    user  User   @relation(fields: [userId], references: [id])
    Nodes Node[]
}

// An individual machine, either Cloud VM or Edge Device
model Node {
    id           String   @id @default(cuid())
    clusterId    String
    name         String
    provider     Provider // Uses the Provider Enum (GCP, AWS, EDGE)
    status       Status // Uses the Status Enum
    isMaster     Boolean  @default(false)
    instanceType String // e.g., "e2-medium", "t2.micro"
    cpuCores     Int
    memoryGB     Int

    credentialId String
    credential   CloudCredential @relation(fields: [credentialId], references: [id])

    // Connection details
    publicIp  String?
    privateIp String?
    machineId String? // The provider's internal ID (e.g., GCP instance name, AWS InstanceId)

    // Link to the EdgeDevice if it's an EDGE node
    edgeDeviceId String?     @unique
    edgeDevice   EdgeDevice? @relation(fields: [edgeDeviceId], references: [id])

    cluster Cluster @relation(fields: [clusterId], references: [id])
}
